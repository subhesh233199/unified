<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RRR Analysis Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.0.12/lib/marked.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/jsoneditor@9.10.2/dist/jsoneditor.min.js"></script>
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold mb-6 text-center">RRR Analysis Tool</h1>

        <div class="mb-8">
            <form id="analyzeForm" class="mb-4">
                <div class="mb-4">
                    <label for="folderPath" class="block text-lg font-medium text-gray-700">Enter Folder Path</label>
                    <input type="text" id="folderPath" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                </div>
                <div class="mt-2">
                    <label class="inline-flex items-center">
                        <input type="checkbox" id="clearCache" class="form-checkbox h-5 w-5 text-blue-600">
                        <span class="ml-2 text-gray-700">Clear Cache</span>
                    </label>
                </div>
                <div class="mt-4">
                    <button type="button" id="analyzeBtn" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">
                        Analyze
                    </button>
                </div>
            </form>
        </div>

        <div id="loading" class="hidden text-center">
            <div class="loader inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-current border-r-transparent align-[-0.125em] text-blue-500 motion-reduce:animate-[spin_1.5s_linear_infinite]"></div>
            <p class="mt-2 text-gray-600">Analyzing PDFs... This may take a few minutes.</p>
        </div>

        <div id="metricsEditor" class="hidden mb-8"></div>

        <div id="reportSection" class="hidden mb-8">
            <h2 class="text-2xl font-semibold mb-4">Analysis Report</h2>
            <div id="report" class="bg-white p-6 rounded-md shadow-md"></div>
            <div class="flex space-x-4 mt-4">
                <button id="editReport" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600">Edit Report</button>
                <button id="saveChanges" class="hidden bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">Save Changes</button>
                <button id="cancelEdit" class="hidden bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Cancel</button>
                <button id="downloadHtml" class="bg-purple-500 text-white px-4 py-2 rounded-md hover:bg-purple-600">Download HTML</button>
                <button id="downloadPdf" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600">Download PDF</button>
            </div>
        </div>

        <div id="visualizationsSection" class="hidden mb-8">
            <h2 class="text-2xl font-semibold mb-4">Visualizations</h2>
            <div id="visualizations" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </div>

        <div id="evaluationSection" class="hidden mb-8">
            <h2 class="text-2xl font-semibold mb-4">Evaluation</h2>
            <div id="evaluation" class="bg-white p-6 rounded-md shadow-md"></div>
        </div>

        <div id="hyperlinksSection" class="hidden mb-8">
            <h2 class="text-2xl font-semibold mb-4">Hyperlinks</h2>
            <div id="hyperlinks" class="bg-white p-6 rounded-md shadow-md">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">URL</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Context</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Page</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Source File</th>
                        </tr>
                    </thead>
                    <tbody id="hyperlinksBody" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Initialize JSONEditor for metrics editing
        const metricsEditorContainer = document.getElementById('metricsEditor');
        const metricsEditor = new JSONEditor(metricsEditorContainer, { mode: 'tree' });
        let originalReport = '';
        let currentMetrics = null;

        // Toggle loading indicator
        function toggleLoading(show) {
            document.getElementById('loading').classList.toggle('hidden', !show);
        }

        // Display visualizations as images
        function displayVisualizations(base64Images) {
            const vizDiv = document.getElementById('visualizations');
            vizDiv.innerHTML = '';
            base64Images.forEach(img => {
                const imgElement = document.createElement('img');
                imgElement.src = `data:image/png;base64,${img}`;
                imgElement.className = 'w-full h-auto rounded-md shadow-md';
                vizDiv.appendChild(imgElement);
            });
        }

        // Render markdown report
        function displayReport(markdown) {
            const reportDiv = document.getElementById('report');
            reportDiv.innerHTML = marked.parse(markdown);
        }

        // Display evaluation score and text
        function displayEvaluation(evaluation) {
            const evalDiv = document.getElementById('evaluation');
            evalDiv.innerHTML = `<p><strong>Score:</strong> ${evaluation.score}</p><p><strong>Evaluation:</strong> ${evaluation.text}</p>`;
        }

        // Display hyperlinks in a table
        function displayHyperlinks(hyperlinks) {
            const hyperlinksBody = document.getElementById('hyperlinksBody');
            hyperlinksBody.innerHTML = '';
            hyperlinks.forEach(link => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <a href="${link.url}" target="_blank" class="text-blue-500 hover:underline">${link.url}</a>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">${link.context}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${link.page}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${link.source_file}</td>
                `;
                hyperlinksBody.appendChild(row);
            });
        }

        // Enable report editing
        function editReport() {
            const reportDiv = document.getElementById('report');
            originalReport = reportDiv.innerHTML;
            const markdown = reportDiv.textContent;
            reportDiv.innerHTML = `<textarea id="reportEditor" class="w-full h-96 border border-gray-300 rounded-md p-4">${markdown}</textarea>`;
            document.getElementById('saveChanges').classList.remove('hidden');
            document.getElementById('cancelEdit').classList.remove('hidden');
            document.getElementById('editReport').classList.add('hidden');
            document.getElementById('metricsEditor').classList.remove('hidden');
            metricsEditor.set(currentMetrics || {});
        }

        // Cancel report and metrics editing
        function cancelEdit() {
            const reportDiv = document.getElementById('report');
            reportDiv.innerHTML = originalReport;
            document.getElementById('saveChanges').classList.add('hidden');
            document.getElementById('cancelEdit').classList.add('hidden');
            document.getElementById('editReport').classList.remove('hidden');
            document.getElementById('metricsEditor').classList.add('hidden');
        }

        // Download report as HTML
        function downloadHTML() {
            const reportDiv = document.getElementById('report');
            const blob = new Blob([reportDiv.innerHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'report.html';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Download report and visualizations as PDF
        function downloadPDF() {
            const element = document.getElementById('report');
            html2pdf().set({ 
                margin: 1, 
                filename: 'report.pdf', 
                html2canvas: { scale: 2 }, 
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } 
            }).from(element).save();
        }

        // Validate form input
        function validateForm() {
            const folderPath = document.getElementById('folderPath').value;
            if (!folderPath.trim()) {
                alert('Folder path cannot be empty');
                return false;
            }
            return true;
        }

        // Call /analyze endpoint
        async function analyze() {
            if (!validateForm()) return;
            toggleLoading(true);
            try {
                const folderPath = document.getElementById('folderPath').value;
                const clearCache = document.getElementById('clearCache').checked;
                const response = await fetch('http://127.0.0.1:8080/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ folder_path: folderPath, clear_cache: clearCache })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    alert(`Error: ${error.detail}`);
                    return;
                }
                
                const data = await response.json();
                currentMetrics = data.metrics;
                metricsEditor.set(data.metrics);
                displayVisualizations(data.visualizations);
                displayReport(data.report);
                displayEvaluation(data.evaluation);
                displayHyperlinks(data.hyperlinks);
                
                // Show all sections
                document.getElementById('reportSection').classList.remove('hidden');
                document.getElementById('visualizationsSection').classList.remove('hidden');
                document.getElementById('evaluationSection').classList.remove('hidden');
                document.getElementById('hyperlinksSection').classList.remove('hidden');
            } catch (error) {
                alert(`Error: ${error.message}`);
            } finally {
                toggleLoading(false);
            }
        }

        // Call /update_metrics endpoint
        async function saveChanges() {
            const folderPath = document.getElementById('folderPath').value;
            const updatedMetrics = metricsEditor.get();
            const updatedReport = document.getElementById('reportEditor').value;
            try {
                const response = await fetch('http://127.0.0.1:8080/update_metrics', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        folder_path: folderPath,
                        metrics: updatedMetrics,
                        report: updatedReport
                    })
                });
                if (!response.ok) {
                    const error = await response.json();
                    alert(`Error: ${error.detail}`);
                    return;
                }
                const data = await response.json();
                currentMetrics = data.metrics;
                metricsEditor.set(data.metrics);
                displayVisualizations(data.visualizations);
                displayReport(data.report);
                displayEvaluation(data.evaluation);
                displayHyperlinks(data.hyperlinks);
                cancelEdit();
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        // Check backend health
        async function checkHealth() {
            try {
                const response = await fetch('http://127.0.0.1:8080/health');
                const data = await response.json();
                const statusDiv = document.createElement('div');
                statusDiv.textContent = `Backend Status: ${data.status}`;
                statusDiv.className = data.status === 'healthy' ? 'bg-green-100 text-green-800 p-3 rounded-md mb-4' : 'bg-red-100 text-red-800 p-3 rounded-md mb-4';
                document.body.insertBefore(statusDiv, document.body.firstChild);
            } catch (error) {
                console.error('Health check failed:', error);
            }
        }

        // Attach event listeners
        document.getElementById('analyzeBtn').addEventListener('click', analyze);
        document.getElementById('editReport').addEventListener('click', editReport);
        document.getElementById('saveChanges').addEventListener('click', saveChanges);
        document.getElementById('cancelEdit').addEventListener('click', cancelEdit);
        document.getElementById('downloadHtml').addEventListener('click', downloadHTML);
        document.getElementById('downloadPdf').addEventListener('click', downloadPDF);

        // Run health check on load
        window.addEventListener('load', () => {
            checkHealth();
        });
    </script>
</body>
</html>
