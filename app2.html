<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RRR Analysis Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked@4.0.12/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jsoneditor@9.10.2/dist/jsoneditor.min.js"></script>
</head>
<body>
    <div class="container">
        <h1 class="my-4">RRR Analysis Tool</h1>

        <div class="mb-4">
            <form id="analyzeForm">
                <div class="mb-3">
                    <label for="folderPath" class="form-label">Enter Folder Path</label>
                    <input type="text" class="form-control" id="folderPath" required>
                </div>
                <div class="form-check mb-3">
                    <input type="checkbox" class="form-check-input" id="clearCache">
                    <label class="form-check-label" for="clearCache">Clear Cache</label>
                </div>
                <button type="button" class="btn btn-primary" id="analyzeBtn">Analyze</button>
            </form>
        </div>

        <div id="loading" class="alert alert-info" style="display: none;">
            Analyzing PDFs... This may take a few minutes.
        </div>

        <div id="metricsEditor" style="display: none;"></div>

        <div id="reportSection">
            <h2>Analysis Report</h2>
            <div id="report" class="border p-3"></div>
            <button id="editReport" class="btn btn-primary mt-2">Edit Report</button>
            <button id="saveChanges" class="btn btn-success mt-2" style="display:none;">Save Changes</button>
            <button id="cancelEdit" class="btn btn-secondary mt-2" style="display:none;">Cancel</button>
            <button id="downloadHtml" class="btn btn-info mt-2">Download HTML</button>
            <button id="downloadPdf" class="btn btn-info mt-2">Download PDF</button>
        </div>

        <div id="visualizationsSection">
            <h2>Visualizations</h2>
            <div id="visualizations"></div>
        </div>

        <div id="evaluationSection">
            <h2>Evaluation</h2>
            <div id="evaluation"></div>
        </div>

        <div id="hyperlinksSection">
            <h2>Hyperlinks</h2>
            <div id="hyperlinks"></div>
        </div>
    </div>

    <script>
        // Initialize JSONEditor for metrics editing
        const metricsEditorContainer = document.getElementById('metricsEditor');
        const metricsEditor = new JSONEditor(metricsEditorContainer, { mode: 'tree' });
        let originalReport = '';
        let currentMetrics = null;

        // Toggle loading indicator
        function toggleLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // Display visualizations as images
        function displayVisualizations(base64Images) {
            const vizDiv = document.getElementById('visualizations');
            vizDiv.innerHTML = '';
            base64Images.forEach(img => {
                const imgElement = document.createElement('img');
                imgElement.src = `data:image/png;base64,${img}`;
                imgElement.style.maxWidth = '100%';
                vizDiv.appendChild(imgElement);
            });
        }

        // Render markdown report
        function displayReport(markdown) {
            const reportDiv = document.getElementById('report');
            reportDiv.innerHTML = marked.parse(markdown);
        }

        // Display evaluation score and text
        function displayEvaluation(evaluation) {
            const evalDiv = document.getElementById('evaluation');
            evalDiv.innerHTML = `<p>Score: ${evaluation.score}</p><p>${evaluation.text}</p>`;
        }

        // Display hyperlinks in a table
        function displayHyperlinks(hyperlinks) {
            const hyperlinksDiv = document.getElementById('hyperlinks');
            let html = '<table class="table"><tr><th>URL</th><th>Context</th><th>Page</th><th>Source File</th></tr>';
            hyperlinks.forEach(link => {
                html += `<tr><td><a href="${link.url}" target="_blank">${link.url}</a></td><td>${link.context}</td><td>${link.page}</td><td>${link.source_file}</td></tr>`;
            });
            html += '</table>';
            hyperlinksDiv.innerHTML = html;
        }

        // Enable report editing
        function editReport() {
            const reportDiv = document.getElementById('report');
            originalReport = reportDiv.innerHTML;
            const markdown = reportDiv.textContent; // Approximate markdown from rendered HTML
            reportDiv.innerHTML = `<textarea id="reportEditor" rows="20" class="form-control">${markdown}</textarea>`;
            document.getElementById('saveChanges').style.display = 'inline';
            document.getElementById('cancelEdit').style.display = 'inline';
            document.getElementById('editReport').style.display = 'none';
            document.getElementById('metricsEditor').style.display = 'block';
            metricsEditor.set(currentMetrics || {});
        }

        // Cancel report and metrics editing
        function cancelEdit() {
            const reportDiv = document.getElementById('report');
            reportDiv.innerHTML = originalReport;
            document.getElementById('saveChanges').style.display = 'none';
            document.getElementById('cancelEdit').style.display = 'none';
            document.getElementById('editReport').style.display = 'inline';
            document.getElementById('metricsEditor').style.display = 'none';
        }

        // Download report as HTML
        function downloadHTML() {
            const reportDiv = document.getElementById('report');
            const blob = new Blob([reportDiv.innerHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'report.html';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Download report and visualizations as PDF
        async function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const reportDiv = document.getElementById('report');
            const vizDiv = document.getElementById('visualizations');
            let y = 10;
            await doc.html(reportDiv, {
                callback: function (doc) {
                    vizDiv.querySelectorAll('img').forEach((img, index) => {
                        if (index > 0) doc.addPage();
                        doc.addImage(img.src, 'PNG', 10, 10, 190, 100);
                    });
                    doc.save('report.pdf');
                },
                x: 10,
                y: y,
                width: 190,
                windowWidth: reportDiv.offsetWidth
            });
        }

        // Validate form input
        function validateForm() {
            const folderPath = document.getElementById('folderPath').value;
            if (!folderPath.trim()) {
                alert('Folder path cannot be empty');
                return false;
            }
            return true;
        }

        // Call /analyze endpoint
        async function analyze() {
            if (!validateForm()) return;
            toggleLoading(true);
            try {
                const folderPath = document.getElementById('folderPath').value;
                const clearCache = document.getElementById('clearCache').checked;
                console.log('Sending request to /analyze with:', { folder_path: folderPath, clear_cache: clearCache });
                const response = await fetch('http://127.0.0.1:8080/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ folder_path: folderPath, clear_cache: clearCache })
                });
                if (!response.ok) {
                    const error = await response.json();
                    console.error('Backend Error:', error);
                    alert(`Error: ${error.detail}`);
                    return;
                }
                const data = await response.json();
                console.log('Received response:', data);
                currentMetrics = data.metrics;
                metricsEditor.set(data.metrics);
                displayVisualizations(data.visualizations);
                displayReport(data.report);
                displayEvaluation(data.evaluation);
                displayHyperlinks(data.hyperlinks);
            } catch (error) {
                console.error('Fetch Error:', error);
                alert(`Error: ${error.message}`);
            } finally {
                toggleLoading(false);
            }
        }

        // Call /update_metrics endpoint
        async function saveChanges() {
            const folderPath = document.getElementById('folderPath').value;
            const updatedMetrics = metricsEditor.get();
            const updatedReport = document.getElementById('reportEditor').value;
            try {
                const response = await fetch('http://127.0.0.1:8080/update_metrics', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        folder_path: folderPath,
                        metrics: updatedMetrics,
                        report: updatedReport
                    })
                });
                if (!response.ok) {
                    const error = await response.json();
                    alert(`Error: ${error.detail}`);
                    return;
                }
                const data = await response.json();
                currentMetrics = data.metrics;
                metricsEditor.set(data.metrics);
                displayVisualizations(data.visualizations);
                displayReport(data.report);
                displayEvaluation(data.evaluation);
                displayHyperlinks(data.hyperlinks);
                cancelEdit();
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        // Check backend health
        async function checkHealth() {
            try {
                const response = await fetch('http://127.0.0.1:8080/health');
                const data = await response.json();
                const statusDiv = document.createElement('div');
                statusDiv.textContent = `Backend Status: ${data.status}`;
                statusDiv.className = data.status === 'healthy' ? 'alert alert-success' : 'alert alert-danger';
                document.body.insertBefore(statusDiv, document.body.firstChild);
            } catch (error) {
                console.error('Health check failed:', error);
            }
        }

        // Attach event listeners
        document.getElementById('analyzeBtn').addEventListener('click', analyze);
        document.getElementById('editReport').addEventListener('click', editReport);
        document.getElementById('saveChanges').addEventListener('click', saveChanges);
        document.getElementById('cancelEdit').addEventListener('click', cancelEdit);
        document.getElementById('downloadHtml').addEventListener('click', downloadHTML);
        document.getElementById('downloadPdf').addEventListener('click', downloadPDF);

        // Run health check on load
        window.addEventListener('load', () => {
            checkHealth();
        });
    </script>
</body>
</html>
